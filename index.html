<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Covid19 Jawa Barat</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
    ></script>

    <style>
      body {
        padding: 0;
        margin: 0;
      }
      html,
      body,
      #mapid {
        height: 100%;
        width: 100vw;
      }
    </style>
  </head>
  <body>
    <div id="mapid"></div>

    <script>
      var mymap = L.map("mapid").setView([-6.904467, 107.609807], 9.5);
      // load a tile layer

      L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(mymap);

      var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.responseType = "json";
        xhr.onload = function() {
          var status = xhr.status;
          if (status === 200) {
            callback(null, xhr.response);
          } else {
            callback(status, xhr.response);
          }
        };
        xhr.send();
      };

      function status(value, stage) {
        if (value == "ODP") {
          return "Orang Dalam Pemantauan";
        } else if (value == "PDP") {
          return "Pasien Dalam Pemantauan";
        } else if (value == "Positif") {
          if (stage == "Sembuh") {
            return "Positif (Sembuh)";
          } else if (stage == "Meninggal") {
            return "Positif (Meninggal)";
          } else if (stage == "Aktif") {
            return "Positif (Aktif)";
          } else {
            return "Positif";
          }
        }
      }

      var iconODP = L.icon({
        iconUrl: "assets/odp.png",
        iconSize: [32, 32] // size of the icon
      });

      var iconPDP = L.icon({
        iconUrl: "assets/pdp.png",
        iconSize: [32, 32] // size of the icon
      });

      var iconPositif = L.icon({
        iconUrl: "assets/positif.png",
        iconSize: [32, 32] // size of the icon
      });

      var iconSembuh = L.icon({
        iconUrl: "assets/sembuh.png",
        iconSize: [32, 32] // size of the icon
      });

      var iconMeinggal = L.icon({
        iconUrl: "assets/meninggal.png",
        iconSize: [32, 32] // size of the icon
      });

      function iconFile(value, stage) {
        if (value == "ODP") {
          return iconODP;
        } else if (value == "PDP") {
          return iconPDP;
        } else if (value == "Positif") {
          if (stage == "Sembuh") {
            return iconSembuh;
          } else if (stage == "Meninggal") {
            return iconMeinggal;
          } else if (stage == "Aktif") {
            return iconPositif;
          } else {
            return iconPositif;
          }
        }
      }

      getJSON(
        "https://covid19-public.digitalservice.id/analytics/longlat/",
        function(err, data) {
          if (err !== null) {
            alert("Something went wrong: " + err);
          } else {
            // alert("Your query count: " + data.data.length);
            for (var i = 0; i < data.data.length; i++) {
              if (data.data[i]["wilayah_status_stage_latitude"] != null) {
                marker = new L.marker(
                  [
                    data.data[i]["wilayah_status_stage_latitude"],
                    data.data[i]["wilayah_status_stage_longitude"]
                  ],
                  {
                    icon: iconFile(
                      data.data[i]["status"],
                      data.data[i]["stage"]
                    )
                  }
                )
                  .bindPopup(
                    "<b>" +
                      status(data.data[i]["status"], data.data[i]["stage"]) +
                      "</b><br>" +
                      data.data[i]["jenis_kelamin_str"] +
                      ", " +
                      data.data[i]["umur"] +
                      " tahun" +
                      "<br>" +
                      data.data[i]["desa_str"] +
                      ", " +
                      data.data[i]["kecamatan_str"] +
                      ", " +
                      data.data[i]["kabkot_str"]
                  )
                  .addTo(mymap);
              }
            }
          }
        }
      );
    </script>
  </body>
</html>
